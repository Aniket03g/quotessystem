---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Quote Details - Grove Systems" currentPage="quotes">
  <!-- Back Button -->
  <div class="mb-6">
    <a href="/quotes" class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to Quotes
    </a>
  </div>

  <!-- Loading State -->
  <div id="loading" class="py-12 text-center">
    <svg class="animate-spin w-8 h-8 text-blue-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-sm text-slate-600">Loading quote details...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden mx-auto max-w-2xl p-4 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-start gap-3">
      <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-sm text-red-800" id="errorText"></p>
    </div>
  </div>

  <!-- Quote Details Content -->
  <div id="quoteContent" class="hidden space-y-6">
    <!-- Header Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h1 id="quoteSubject" class="text-2xl font-semibold text-slate-800 mb-2">Loading...</h1>
          <div class="flex items-center gap-4 text-sm text-slate-600">
            <span id="quoteDate">Date: --</span>
            <span class="text-slate-300">•</span>
            <span id="quoteVersion">Version: --</span>
          </div>
        </div>
        <div class="flex gap-2 items-center">
          <div class="flex items-center gap-2">
            <label for="logoSelect" class="text-sm font-medium text-slate-700">Logo:</label>
            <select id="logoSelect" class="px-3 py-2 bg-white border border-slate-300 text-slate-700 text-sm rounded-lg hover:bg-slate-50 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="greenocare">GreenOCare</option>
              <option value="grove">Grove Systems</option>
            </select>
          </div>
          <button id="editQuoteBtn" class="inline-flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Edit Products
          </button>
          <button id="previewPdfBtn" class="inline-flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            Preview PDF
          </button>
          <button id="downloadPdfBtn" class="inline-flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3 3m0 0l-3-3m3 3V10"></path>
            </svg>
            Download PDF
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Status</p>
          <span id="quoteStatus" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
            Draft
          </span>
        </div>
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Total Amount</p>
          <p id="quoteTotal" class="text-lg font-semibold text-slate-900">₹0</p>
        </div>
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Valid Until</p>
          <p id="quoteValidUntil" class="text-sm text-slate-700">--</p>
        </div>
      </div>
    </div>

    <!-- Account Information Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">Account Information</h2>
      <div id="accountInfo" class="space-y-2">
        <div class="flex items-start gap-2">
          <svg class="w-5 h-5 text-slate-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          <div>
            <p class="text-sm font-medium text-slate-700" id="accountName">Loading...</p>
            <p class="text-xs text-slate-500" id="accountDetails"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Mode Panel (shown when editing) -->
    <div id="editModePanel" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border-2 border-blue-200 p-6 mb-6">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-lg font-semibold text-slate-800 mb-1">Edit Quote</h3>
          <p class="text-sm text-slate-600">Make changes to products and quote status</p>
        </div>
        <div class="flex gap-2">
          <button id="cancelEditBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </button>
          <button id="saveEditBtn" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Save Changes
          </button>
        </div>
      </div>

      <!-- Quote Status Section -->
      <div class="bg-white rounded-xl p-4 mb-4 border border-slate-200">
        <label class="block text-sm font-medium text-slate-700 mb-2">Quote Status</label>
        <select id="editQuoteStatus" class="w-full max-w-xs px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
          <option value="Draft">Draft</option>
          <option value="Sent">Sent</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="Final">Final</option>
        </select>
      </div>

      <!-- Add Product Section -->
      <div class="bg-white rounded-xl p-4 border border-slate-200">
        <label class="block text-sm font-medium text-slate-700 mb-3">
          <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Product to Quote
        </label>
        <div class="flex gap-3">
          <div class="flex-1 relative">
            <input 
              type="text" 
              id="newProductSearch" 
              placeholder="Search by product name or code..." 
              autocomplete="off"
              class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            />
            <div id="newProductDropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
              <div id="newProductResults" class="py-1"></div>
              <div id="newProductLoading" class="hidden px-4 py-3 text-sm text-slate-500 text-center">
                <svg class="animate-spin w-4 h-4 inline-block mr-2" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Searching...
              </div>
              <div id="newProductEmpty" class="hidden px-4 py-3 text-sm text-slate-500 text-center">No products found</div>
            </div>
          </div>
          <button id="addProductToQuoteBtn" class="inline-flex items-center gap-2 px-5 py-2.5 bg-emerald-600 text-white text-sm font-medium rounded-lg hover:bg-emerald-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add
          </button>
        </div>
      </div>
    </div>

    <!-- Products Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-slate-800">Products</h2>
      </div>
      <div id="productsContainer">
        <div class="text-sm text-slate-500">Loading products...</div>
      </div>
    </div>

    <!-- Notes Card (if exists) -->
    <div id="notesCard" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">Notes</h2>
      <p id="quoteNotes" class="text-sm text-slate-700 whitespace-pre-wrap"></p>
    </div>
  </div>

  <script>
    import { getToken, logout, safeJsonParse } from '../lib/api';
    import { debounce } from '../utils/debounce';

    const API_BASE_URL = `${window.location.protocol}//${window.location.hostname}:8080`;
     
    const token = getToken();
    if (!token) { 
      window.location.href = '/login';
    }
    
    // Get quote ID from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quoteId = urlParams.get('id');

    if (!quoteId) {
      window.location.href = '/quotes';
    }

    const loadingDiv = document.getElementById('loading') as HTMLDivElement;
    const errorDiv = document.getElementById('error') as HTMLDivElement;
    const errorText = document.getElementById('errorText') as HTMLParagraphElement;
    const quoteContent = document.getElementById('quoteContent') as HTMLDivElement;

    // Store quote data for PDF generation
    let currentQuoteData: any = null;
    
    // Edit mode state
    let isEditMode = false;
    let currentProducts: any[] = [];
    let lineItems: any[] = []; // ProductsForQuotes junction records
    let selectedNewProduct: { id: string; name: string; price: string } | null = null;
    let originalQuoteStatus = '';
    let currentQuoteFields: any = {};

    /**
     * Fetch quote details - same method as PDF download
     * Fetches quote, account, and products in parallel
     */
    async function loadQuoteDetails() {
      try {
        // Fetch quote record to get basic details
        const quoteResponse = await fetch(`${API_BASE_URL}/proxy/quotes/records/${quoteId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        if (quoteResponse.status === 401) {
          logout();
          return;
        }

        if (!quoteResponse.ok) {
          throw new Error('Failed to fetch quote details');
        }

        const quoteData = await safeJsonParse(quoteResponse);
        const fields = quoteData.fields || {};

        // Fetch linked account using same route as PDF generation
        const accountResponse = await fetch(
          `${API_BASE_URL}/proxy/quotes/links/accounts_copy/${quoteId}?fields=Account Name,Phone,Billing Street,Billing City`,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );

        let accountName = 'N/A';
        let accountData = null;
        if (accountResponse.ok) {
          const accountResult = await safeJsonParse(accountResponse);
          const accounts = accountResult.list || accountResult.records || [];
          if (accounts.length > 0) {
            accountData = accounts[0].fields;
            accountName = accountData['Account Name'] || 'N/A';
          }
        }

        // Step 1: Fetch catalog products via links endpoint (WITHOUT Unit Price)
        console.log('[QUOTE DETAIL] Step 1: Fetching catalog products from links endpoint...');
        const catalogResponse = await fetch(
          `${API_BASE_URL}/proxy/quotes/links/products/${quoteId}?fields=Id,Product Name,Brand,HSN Code,Model,Product Code,Tax,Description`,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );

        let products: Array<{ name: string; price?: number }> = [];
        let productRecords: any[] = [];
        
        if (!catalogResponse.ok) {
          console.error('[QUOTE DETAIL] Failed to fetch catalog products');
          throw new Error('Failed to fetch catalog products');
        }

        const catalogData = await safeJsonParse(catalogResponse);
        const catalogProducts = catalogData.list || catalogData.records || [];
        console.log('[QUOTE DETAIL] Catalog products fetched:', catalogProducts.length);
        console.log('[QUOTE DETAIL] Sample catalog product:', catalogProducts[0]);

        // Step 2: Fetch junction table data for custom prices and quantities
        console.log('[QUOTE DETAIL] Step 2: Fetching custom prices from junction table...');
        const junctionResponse = await fetch(
          `${API_BASE_URL}/proxy/products_for_quotes/records?where=(nc_76_d___Quotes_id,eq,${quoteId})&fields=Id,Quantity,Custom%20Unit%20Price,nc_76_d__Products_id`,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );

        let junctionRecords: any[] = [];
        if (junctionResponse.ok) {
          const junctionData = await safeJsonParse(junctionResponse);
          junctionRecords = junctionData.records || [];
          console.log('[QUOTE DETAIL] Junction records fetched:', junctionRecords.length);
          console.log('[QUOTE DETAIL] Sample junction record:', junctionRecords[0]);
        } else {
          console.warn('[QUOTE DETAIL] Failed to fetch junction records - products will show without custom pricing');
        }

        // Step 3: Merge catalog products with junction data by product ID
        console.log('[QUOTE DETAIL] Step 3: Merging catalog and junction data...');
        productRecords = catalogProducts.map((catalogProduct: any) => {
          const productId = catalogProduct.id;
          
          // Find matching junction record by product ID
          const junctionMatch = junctionRecords.find(
            (jr: any) => jr.fields['nc_76_d__Products_id'] === productId
          );

          if (junctionMatch) {
            console.log(`[QUOTE DETAIL] Found junction match for product ${productId}:`, junctionMatch);
            return {
              junctionId: junctionMatch.id,
              productId: productId,
              quantity: junctionMatch.fields['Quantity'] || 1,
              customUnitPrice: junctionMatch.fields['Custom Unit Price'],
              catalogUnitPrice: null, // Not fetched from catalog anymore
              productName: catalogProduct.fields['Product Name'],
              brand: catalogProduct.fields['Brand'],
              hsnCode: catalogProduct.fields['HSN Code'],
              model: catalogProduct.fields['Model'],
              productCode: catalogProduct.fields['Product Code'],
              tax: catalogProduct.fields['Tax'],
              description: catalogProduct.fields['Description']
            };
          } else {
            console.warn(`[QUOTE DETAIL] No junction record found for product ${productId} - using defaults`);
            return {
              junctionId: null,
              productId: productId,
              quantity: 1,
              customUnitPrice: null,
              catalogUnitPrice: null,
              productName: catalogProduct.fields['Product Name'],
              brand: catalogProduct.fields['Brand'],
              hsnCode: catalogProduct.fields['HSN Code'],
              model: catalogProduct.fields['Model'],
              productCode: catalogProduct.fields['Product Code'],
              tax: catalogProduct.fields['Tax'],
              description: catalogProduct.fields['Description']
            };
          }
        });

        console.log('[QUOTE DETAIL] Merged product records:', productRecords.length);
        
        // Map for PDF generation compatibility
        products = productRecords.map((record: any) => ({
          name: record.productName || 'Unnamed Product',
          price: record.customUnitPrice || 0,
          model: record.model,
          productCode: record.productCode,
          tax: record.tax,
          hsnCode: record.hsnCode,
          description: record.description
        }));

        // Store for PDF generation (same structure as download function)
        currentQuoteData = {
          id: parseInt(quoteId || '0'),
          subject: fields['Subject'] || `Quote #${quoteId || 'Unknown'}`,
          date: fields['Quote Date'] || new Date().toISOString().split('T')[0],
          version: fields['Quote Version'] || '1.0',
          total: fields['Total Amount'] || 0,
          account: {
            name: accountName
          },
          products: products
        };

        // Display quote details in UI
        displayQuoteDetails(fields, accountData, productRecords);

        loadingDiv.classList.add('hidden');
        quoteContent.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading quote details:', error);
        loadingDiv.classList.add('hidden');
        errorText.textContent = error instanceof Error ? error.message : 'Failed to load quote details';
        errorDiv.classList.remove('hidden');
      }
    }

    function displayQuoteDetails(fields: any, accountData: any, products: any[]) {
      // Store current quote fields
      currentQuoteFields = fields;
      
      // Header
      (document.getElementById('quoteSubject') as HTMLHeadingElement).textContent = fields['Subject'] || 'Untitled Quote';
      (document.getElementById('quoteDate') as HTMLSpanElement).textContent = `Date: ${fields['Quote Date'] || 'N/A'}`;
      (document.getElementById('quoteVersion') as HTMLSpanElement).textContent = `Version: ${fields['Quote Version'] || '1.0'}`;

      // Status
      const status = fields['Quote Status'] || 'Draft';
      originalQuoteStatus = status;
      const statusEl = document.getElementById('quoteStatus') as HTMLSpanElement;
      statusEl.textContent = status;
      
      let statusClasses = 'bg-slate-100 text-slate-800';
      if (status === 'Sent') statusClasses = 'bg-blue-100 text-blue-800';
      if (status === 'Accepted' || status === 'Approved') statusClasses = 'bg-emerald-100 text-emerald-800';
      if (status === 'Rejected') statusClasses = 'bg-red-100 text-red-800';
      if (status === 'Final') statusClasses = 'bg-purple-100 text-purple-800';
      statusEl.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClasses}`;

      // Total
      const total = fields['Total Amount'] || 0;
      (document.getElementById('quoteTotal') as HTMLParagraphElement).textContent = 
        `₹${Number(total).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

      // Valid Until
      (document.getElementById('quoteValidUntil') as HTMLParagraphElement).textContent = fields['Valid Until'] || 'N/A';

      // Account
      const accountName = accountData?.['Account Name'] || 'No account linked';
      (document.getElementById('accountName') as HTMLParagraphElement).textContent = accountName;
      
      const accountDetails: string[] = [];
      if (accountData?.['Phone']) accountDetails.push(accountData['Phone']);
      if (accountData?.['Billing City']) accountDetails.push(accountData['Billing City']);
      
      const accountDetailsEl = document.getElementById('accountDetails') as HTMLParagraphElement;
      if (accountDetails.length > 0) {
        accountDetailsEl.textContent = accountDetails.join(' • ');
      } else {
        accountDetailsEl.textContent = '';
      }

      // Products
      currentProducts = products;
      renderProducts();

      // Notes
      if (fields['Notes']) {
        const notesCard = document.getElementById('notesCard') as HTMLDivElement;
        const notesText = document.getElementById('quoteNotes') as HTMLParagraphElement;
        notesText.textContent = fields['Notes'];
        notesCard.classList.remove('hidden');
      }
    }

    /**
     * Generate PDF - reuses the same data already fetched
     */
    async function generatePDF(preview: boolean = false) {
      console.log('=== PDF GENERATION START ===');
      console.log('Preview mode:', preview);
      
      if (!currentQuoteData) {
        console.error('ERROR: Quote data not loaded');
        alert('Quote data not loaded');
        return;
      }

      console.log('Quote data:', currentQuoteData);

      try {
        const logoSelect = document.getElementById('logoSelect') as HTMLSelectElement;
        const selectedLogo = logoSelect?.value || 'greenocare';
        console.log('Selected logo:', selectedLogo);

        const requestBody = {
          ...currentQuoteData,
          logo: selectedLogo
        };
        console.log('Request body:', requestBody);

        console.log('Sending POST request to /api/quotes/pdf...');
        const response = await fetch('/api/quotes/pdf', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });

        console.log('Response status:', response.status, response.statusText);
        console.log('Response headers:', Object.fromEntries(response.headers.entries()));

        if (!response.ok) {
          const contentType = response.headers.get('content-type');
          let errorDetails = `Status: ${response.status} ${response.statusText}`;
          
          if (contentType?.includes('application/json')) {
            const errorData = await response.json();
            console.error('ERROR Response (JSON):', errorData);
            errorDetails += `\nDetails: ${JSON.stringify(errorData, null, 2)}`;
          } else {
            const errorText = await response.text();
            console.error('ERROR Response (Text):', errorText);
            errorDetails += `\nResponse: ${errorText}`;
          }
          
          console.error('=== PDF GENERATION FAILED ===');
          console.error(errorDetails);
          alert('Failed to generate PDF:\n' + errorDetails);
          throw new Error(errorDetails);
        }

        console.log('Response OK, creating blob...');

        const blob = await response.blob();
        console.log('Blob created, size:', blob.size, 'bytes, type:', blob.type);
        
        const url = window.URL.createObjectURL(blob);
        console.log('Object URL created:', url);

        if (preview) {
          // Open in new tab for preview
          window.open(url, '_blank');
        } else {
          // Download
          const a = document.createElement('a');
          a.href = url;
          a.download = `quote-${quoteId}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Failed to generate PDF:', error);
        alert('Failed to generate PDF. Please try again.');
      }
    }

    /**
     * Render products table based on edit mode
     * Shows products from ProductsForQuotes junction with custom prices
     */
    function renderProducts() {
      const productsContainer = document.getElementById('productsContainer') as HTMLDivElement;
      
      if (currentProducts.length === 0) {
        productsContainer.innerHTML = '<p class="text-sm text-slate-500">No products linked to this quote</p>';
        return;
      }

      const actionColumn = isEditMode ? '<th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>' : '';
      
      productsContainer.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Product</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Brand</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Product Code</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">HSN Code</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Qty</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Unit Price</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Tax %</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Subtotal</th>
                ${actionColumn}
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
              ${currentProducts.map((product: any) => {
                const name = product.productName || 'Unnamed Product';
                const brand = product.brand || '-';
                const productCode = product.productCode || '-';
                const code = product.hsnCode || '-';
                const customPrice = product.customUnitPrice ? Number(product.customUnitPrice) : null;
                const unitPrice = customPrice !== null ? customPrice : 0;
                const quantity = Number(product.quantity) || 1;
                const taxRate = Number(product.tax) || 0;
                const junctionId = product.junctionId;
                
                // Calculate line total with tax (only if price is set)
                const subtotal = unitPrice * quantity;
                const taxAmount = subtotal * (taxRate / 100);
                const lineTotal = subtotal + taxAmount;
                
                // Editable fields in edit mode
                const qtyCell = isEditMode ? `
                  <td class="px-4 py-3 text-center">
                    <input type="number" min="1" value="${quantity}" 
                      class="quantity-input w-16 px-2 py-1 text-sm text-center border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      data-junction-id="${junctionId}" 
                      ${!junctionId ? 'disabled title="No junction record"' : ''} />
                  </td>
                ` : `<td class="px-4 py-3 text-sm text-slate-900 text-center">${quantity}</td>`;
                
                const priceCell = isEditMode ? `
                  <td class="px-4 py-3 text-right">
                    <input type="number" min="0" step="0.01" value="${unitPrice || ''}" 
                      class="price-input w-28 px-2 py-1 text-sm text-right border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      data-junction-id="${junctionId}" 
                      placeholder="Set price" 
                      ${!junctionId ? 'disabled title="No junction record"' : ''} />
                  </td>
                ` : `<td class="px-4 py-3 text-sm text-slate-900 text-right">${customPrice !== null ? '₹' + unitPrice.toLocaleString('en-IN') : '<span class="text-slate-400">No price set</span>'}</td>`;
                
                const actionCell = isEditMode ? `
                  <td class="px-4 py-3">
                    <button class="remove-product-btn p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors" data-junction-id="${junctionId}" title="Remove product">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </td>
                ` : '';
                
                return `
                  <tr data-junction-id="${junctionId}">
                    <td class="px-4 py-3 text-sm text-slate-900">${name}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${brand}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${productCode}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${code}</td>
                    ${qtyCell}
                    ${priceCell}
                    <td class="px-4 py-3 text-sm text-slate-600 text-center">${taxRate}%</td>
                    <td class="px-4 py-3 text-sm font-medium text-slate-900 text-right subtotal-cell" data-junction-id="${junctionId}">₹${lineTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    ${actionCell}
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;

      // Attach event handlers in edit mode
      if (isEditMode) {
        // Remove button handlers
        document.querySelectorAll('.remove-product-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const junctionId = (btn as HTMLElement).getAttribute('data-junction-id');
            if (junctionId && confirm('Remove this product from the quote?')) {
              await removeLineItem(junctionId);
            }
          });
        });
        
        // Quantity input handlers with debounce
        document.querySelectorAll('.quantity-input').forEach(input => {
          let timeout: number;
          input.addEventListener('input', (e) => {
            clearTimeout(timeout);
            timeout = window.setTimeout(async () => {
              const junctionId = (input as HTMLElement).getAttribute('data-junction-id');
              const newQuantity = parseInt((input as HTMLInputElement).value);
              if (junctionId && newQuantity > 0) {
                await updateLineItemQuantity(junctionId, newQuantity);
              }
            }, 800);
          });
        });
        
        // Price input handlers with debounce
        document.querySelectorAll('.price-input').forEach(input => {
          let timeout: number;
          input.addEventListener('input', (e) => {
            clearTimeout(timeout);
            timeout = window.setTimeout(async () => {
              const junctionId = (input as HTMLElement).getAttribute('data-junction-id');
              const newPrice = parseFloat((input as HTMLInputElement).value);
              if (junctionId && newPrice >= 0) {
                await updateLineItemPrice(junctionId, newPrice);
              }
            }, 800);
          });
        });
      }
    }

    /**
     * Toggle edit mode
     */
    function toggleEditMode(enable: boolean) {
      isEditMode = enable;
      const editModePanel = document.getElementById('editModePanel') as HTMLDivElement;
      const editQuoteBtn = document.getElementById('editQuoteBtn') as HTMLButtonElement;
      const editQuoteStatus = document.getElementById('editQuoteStatus') as HTMLSelectElement;
      
      if (enable) {
        editModePanel.classList.remove('hidden');
        editQuoteBtn.classList.add('hidden');
        // Set current status in dropdown
        if (editQuoteStatus) {
          editQuoteStatus.value = originalQuoteStatus;
        }
        // Scroll to edit panel
        editModePanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        editModePanel.classList.add('hidden');
        editQuoteBtn.classList.remove('hidden');
        // Clear search
        const newProductSearch = document.getElementById('newProductSearch') as HTMLInputElement;
        if (newProductSearch) newProductSearch.value = '';
        selectedNewProduct = null;
        const addBtn = document.getElementById('addProductToQuoteBtn') as HTMLButtonElement;
        if (addBtn) addBtn.disabled = true;
      }
      
      renderProducts();
    }

    /**
     * Calculate total amount from current products including tax
     * Formula: Sum of (Unit Price * Quantity * (1 + Tax%/100))
     * Only includes products with custom prices set
     */
    function calculateTotal(): number {
      return currentProducts.reduce((sum, product) => {
        const customPrice = product.customUnitPrice ? Number(product.customUnitPrice) : null;
        
        // Skip products without custom price
        if (customPrice === null) {
          return sum;
        }
        
        const quantity = Number(product.quantity) || 1;
        const taxRate = Number(product.tax) || 0;
        
        // Calculate: price * quantity * (1 + tax/100)
        const subtotal = customPrice * quantity;
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;
        
        return sum + total;
      }, 0);
    }

    /**
     * Update line item quantity in ProductsForQuotes junction table
     */
    async function updateLineItemQuantity(junctionId: string, newQuantity: number) {
      try {
        console.log(`[LINE ITEM] Updating quantity for junction ${junctionId} to ${newQuantity}`);
        
        const response = await fetch(
          `${API_BASE_URL}/proxy/products_for_quotes/records`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: junctionId,
              fields: {
                'Quantity': newQuantity
              }
            })
          }
        );

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[LINE ITEM] Failed to update quantity:', errorText);
          throw new Error('Failed to update quantity');
        }

        console.log('[LINE ITEM] Quantity updated successfully');
        
        // Update local state
        const product = currentProducts.find(p => p.junctionId === parseInt(junctionId));
        if (product) {
          product.quantity = newQuantity;
        }
        
        // Recalculate and update quote total
        const newTotal = calculateTotal();
        await updateQuote({ "Total Amount": newTotal });
        
        // Update the subtotal display
        updateSubtotalDisplay(junctionId);
      } catch (error) {
        console.error('Error updating quantity:', error);
        alert('Failed to update quantity. Please try again.');
      }
    }

    /**
     * Update line item custom unit price in ProductsForQuotes junction table
     */
    async function updateLineItemPrice(junctionId: string, newPrice: number) {
      try {
        console.log(`[LINE ITEM] Updating custom price for junction ${junctionId} to ${newPrice}`);
        
        const response = await fetch(
          `${API_BASE_URL}/proxy/products_for_quotes/records`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: junctionId,
              fields: {
                'Custom Unit Price': newPrice
              }
            })
          }
        );

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[LINE ITEM] Failed to update price:', errorText);
          throw new Error('Failed to update price');
        }

        console.log('[LINE ITEM] Price updated successfully');
        
        // Update local state
        const product = currentProducts.find(p => p.junctionId === parseInt(junctionId));
        if (product) {
          product.customUnitPrice = newPrice;
        }
        
        // Recalculate and update quote total
        const newTotal = calculateTotal();
        await updateQuote({ "Total Amount": newTotal });
        
        // Update the subtotal display
        updateSubtotalDisplay(junctionId);
      } catch (error) {
        console.error('Error updating price:', error);
        alert('Failed to update price. Please try again.');
      }
    }

    /**
     * Update subtotal display for a specific line item
     */
    function updateSubtotalDisplay(junctionId: string) {
      const product = currentProducts.find(p => p.junctionId === parseInt(junctionId));
      if (!product) return;
      
      const customPrice = product.customUnitPrice ? Number(product.customUnitPrice) : null;
      const quantity = Number(product.quantity) || 1;
      const taxRate = Number(product.tax) || 0;
      
      const subtotalCell = document.querySelector(`.subtotal-cell[data-junction-id="${junctionId}"]`);
      if (subtotalCell) {
        if (customPrice === null) {
          subtotalCell.innerHTML = '<span class="text-slate-400">No price set</span>';
        } else {
          const subtotal = customPrice * quantity;
          const taxAmount = subtotal * (taxRate / 100);
          const lineTotal = subtotal + taxAmount;
          subtotalCell.textContent = `₹${lineTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
      }
    }

    /**
     * Remove line item from ProductsForQuotes junction table
     */
    async function removeLineItem(junctionId: string) {
      try {
        console.log(`[LINE ITEM] Removing junction record ${junctionId}`);
        
        const response = await fetch(
          `${API_BASE_URL}/proxy/products_for_quotes/records/${junctionId}`,
          {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            }
          }
        );

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[LINE ITEM] Failed to remove line item:', errorText);
          throw new Error('Failed to remove line item');
        }

        console.log('[LINE ITEM] Line item removed successfully');
        
        // Remove from local state
        currentProducts = currentProducts.filter(p => p.junctionId !== parseInt(junctionId));
        renderProducts();
        
        // Recalculate total and update quote
        const newTotal = calculateTotal();
        await updateQuote({ "Total Amount": newTotal });
        
        // Reload quote to get updated data
        await loadQuoteDetails();
      } catch (error) {
        console.error('Error removing line item:', error);
        alert('Failed to remove product. Please try again.');
      }
    }

    /**
     * Update quote fields using PATCH
     * Endpoint: PATCH /proxy/quotes/records
     * Body: { "id": "47", "fields": { "Total Amount": 12345 } }
     */
    async function updateQuote(fields: { [key: string]: any }) {
      try {
        const response = await fetch(
          `${API_BASE_URL}/proxy/quotes/records`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: quoteId,
              fields: fields
            })
          }
        );

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to update quote');
        }

        return await safeJsonParse(response);
      } catch (error) {
        console.error('Error updating quote:', error);
        throw error;
      }
    }

    /**
     * Unlink a product from the quote
     * Uses NocoDB record ID from the linked products response
     */
    async function unlinkProduct(recordId: string) {
      try {
        const response = await fetch(
          `${API_BASE_URL}/proxy/quotes/links/products/${quoteId}`,
          {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify([parseInt(recordId)])
          }
        );

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to unlink product');
        }

        // Remove from local state using NocoDB record ID
        currentProducts = currentProducts.filter(p => p.id !== parseInt(recordId));
        renderProducts();
        
        // Recalculate total and update quote
        const newTotal = calculateTotal();
        await updateQuote({ "Total Amount": newTotal });
        
        // Reload quote to get updated data
        await loadQuoteDetails();
      } catch (error) {
        console.error('Error unlinking product:', error);
        alert('Failed to remove product. Please try again.');
      }
    }

    /**
     * Add a new product to the quote via ProductsForQuotes junction table
     * Creates junction record with custom price (defaults to catalog price)
     */
    async function linkProduct(productId: string) {
      try {
        console.log(`[ADD PRODUCT] Adding product ${productId} to quote ${quoteId}`);
        
        // Get the catalog price from selectedNewProduct
        const catalogPrice = selectedNewProduct?.price ? parseFloat(selectedNewProduct.price) : 0;
        
        // Step 1: Link product to quote (for compatibility)
        console.log('[ADD PRODUCT] Step 1: Linking product via links endpoint');
        const linkResponse = await fetch(
          `${API_BASE_URL}/proxy/quotes/links/products/${quoteId}`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify([parseInt(productId)])
          }
        );

        if (linkResponse.status === 401) {
          logout();
          return;
        }

        if (!linkResponse.ok) {
          const errorText = await linkResponse.text();
          console.error('[ADD PRODUCT] Failed to link product:', errorText);
          throw new Error('Failed to link product');
        }

        console.log('[ADD PRODUCT] Product linked successfully');

        // Step 2: Create ProductsForQuotes junction record with custom price
        console.log('[ADD PRODUCT] Step 2: Creating ProductsForQuotes junction record');
        const junctionPayload = {
          fields: {
            'Quotes': parseInt(quoteId!),
            'Products': parseInt(productId),
            'Quantity': 1,
            'Custom Unit Price': catalogPrice
          }
        };

        console.log('[ADD PRODUCT] Junction payload:', JSON.stringify(junctionPayload));

        const junctionResponse = await fetch(
          `${API_BASE_URL}/proxy/products_for_quotes/records`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(junctionPayload)
          }
        );

        if (junctionResponse.status === 401) {
          logout();
          return;
        }

        if (!junctionResponse.ok) {
          const errorText = await junctionResponse.text();
          console.error('[ADD PRODUCT] Failed to create junction record:', errorText);
          throw new Error('Failed to create ProductsForQuotes record');
        }

        const junctionResult = await safeJsonParse(junctionResponse);
        console.log('[ADD PRODUCT] Junction record created:', junctionResult);

        // Clear selection
        selectedNewProduct = null;
        const newProductSearch = document.getElementById('newProductSearch') as HTMLInputElement;
        newProductSearch.value = '';
        const addBtn = document.getElementById('addProductToQuoteBtn') as HTMLButtonElement;
        addBtn.disabled = true;
        
        // Reload quote to get updated products
        await loadQuoteDetails();
        
        // Recalculate total and update quote
        const newTotal = calculateTotal();
        await updateQuote({ "Total Amount": newTotal });
        
        console.log('[ADD PRODUCT] Product added successfully');
      } catch (error) {
        console.error('Error adding product:', error);
        alert('Failed to add product. Please try again.');
      }
    }

    /**
     * Search products with debounce
     */
    async function searchProducts(searchTerm: string) {
      const dropdown = document.getElementById('newProductDropdown') as HTMLDivElement;
      const results = document.getElementById('newProductResults') as HTMLDivElement;
      const loading = document.getElementById('newProductLoading') as HTMLDivElement;
      const empty = document.getElementById('newProductEmpty') as HTMLDivElement;

      if (!searchTerm || searchTerm.length < 2) {
        dropdown.classList.add('hidden');
        return;
      }

      try {
        loading.classList.remove('hidden');
        results.innerHTML = '';
        empty.classList.add('hidden');
        dropdown.classList.remove('hidden');

        const rawWhere = `(Product Name,like,%${searchTerm}%)~or(Product Code,like,%${searchTerm}%)`;
        const encodedWhere = encodeURIComponent(rawWhere);
        const queryString = `where=${encodedWhere}&pageSize=15`;

        const response = await fetch(`${API_BASE_URL}/proxy/products/records?${queryString}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        loading.classList.add('hidden');

        if (response.status === 401) {
          logout();
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to search products');
        }

        const data = await safeJsonParse(response);
        const products = data.records || [];

        if (products.length === 0) {
          empty.classList.remove('hidden');
          return;
        }

        results.innerHTML = products.map((prod: any) => {
          const name = prod.fields?.['Product Name'] || 'Unnamed';
          const brand = prod.fields?.['Brand'] || '';
          const price = prod.fields?.['Unit Price'] || 0;
          return `
            <button type="button" class="product-option w-full px-4 py-2.5 text-left hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-b-0" data-id="${prod.id}" data-name="${name}" data-price="${price}">
              <div class="text-sm font-medium text-slate-900">${name}</div>
              <div class="text-xs text-slate-500 mt-0.5">${brand ? brand + ' • ' : ''}₹${price}</div>
            </button>
          `;
        }).join('');

        // Add click handlers
        results.querySelectorAll('.product-option').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');
            const price = btn.getAttribute('data-price');
            selectNewProduct(id!, name!, price!);
          });
        });
      } catch (error) {
        console.error('Failed to search products:', error);
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
      }
    }

    /**
     * Select a product from search results
     */
    function selectNewProduct(id: string, name: string, price: string) {
      selectedNewProduct = { id, name, price };
      const searchInput = document.getElementById('newProductSearch') as HTMLInputElement;
      const dropdown = document.getElementById('newProductDropdown') as HTMLDivElement;
      const addBtn = document.getElementById('addProductToQuoteBtn') as HTMLButtonElement;
      
      searchInput.value = `${name} - ₹${price}`;
      dropdown.classList.add('hidden');
      addBtn.disabled = false;
    }

    // Event listeners
    document.getElementById('editQuoteBtn')?.addEventListener('click', () => toggleEditMode(true));
    document.getElementById('cancelEditBtn')?.addEventListener('click', () => {
      toggleEditMode(false);
      // Reload to reset any unsaved changes
      loadQuoteDetails();
    });
    document.getElementById('saveEditBtn')?.addEventListener('click', async () => {
      try {
        // Check if status changed
        const editQuoteStatus = document.getElementById('editQuoteStatus') as HTMLSelectElement;
        const newStatus = editQuoteStatus?.value;
        
        if (newStatus && newStatus !== originalQuoteStatus) {
          await updateQuote({ "Quote Status": newStatus });
        }
        
        toggleEditMode(false);
        // Reload to show updated data
        await loadQuoteDetails();
        
        // Show success message
        const statusEl = document.getElementById('quoteStatus') as HTMLSpanElement;
        const originalText = statusEl.textContent;
        statusEl.textContent = '✓ Saved';
        setTimeout(() => {
          if (statusEl.textContent === '✓ Saved') {
            statusEl.textContent = originalText;
          }
        }, 2000);
      } catch (error) {
        console.error('Error saving changes:', error);
        alert('Failed to save changes. Please try again.');
      }
    });
    
    document.getElementById('addProductToQuoteBtn')?.addEventListener('click', async () => {
      if (selectedNewProduct) {
        await linkProduct(selectedNewProduct.id);
      }
    });

    // Product search with debounce
    const debouncedProductSearch = debounce((searchTerm: string) => {
      searchProducts(searchTerm);
    }, 400);

    document.getElementById('newProductSearch')?.addEventListener('input', (e) => {
      const searchTerm = (e.target as HTMLInputElement).value;
      debouncedProductSearch(searchTerm);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('newProductDropdown') as HTMLDivElement;
      const searchInput = document.getElementById('newProductSearch') as HTMLInputElement;
      if (dropdown && searchInput && !dropdown.contains(e.target as Node) && e.target !== searchInput) {
        dropdown.classList.add('hidden');
      }
    });

    document.getElementById('previewPdfBtn')?.addEventListener('click', () => generatePDF(true));
    document.getElementById('downloadPdfBtn')?.addEventListener('click', () => generatePDF(false));

    // Load quote details on page load
    loadQuoteDetails();
  </script>
</DashboardLayout>
