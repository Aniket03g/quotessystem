---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Quote Details - Grove Systems" currentPage="quotes">
  <!-- Back Button -->
  <div class="mb-6">
    <a href="/quotes" class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to Quotes
    </a>
  </div>

  <!-- Loading State -->
  <div id="loading" class="py-12 text-center">
    <svg class="animate-spin w-8 h-8 text-blue-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-sm text-slate-600">Loading quote details...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden mx-auto max-w-2xl p-4 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-start gap-3">
      <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-sm text-red-800" id="errorText"></p>
    </div>
  </div>

  <!-- Quote Details Content -->
  <div id="quoteContent" class="hidden space-y-6">
    <!-- Header Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h1 id="quoteSubject" class="text-2xl font-semibold text-slate-800 mb-2">Loading...</h1>
          <div class="flex items-center gap-4 text-sm text-slate-600">
            <span id="quoteDate">Date: --</span>
            <span class="text-slate-300">•</span>
            <span id="quoteVersion">Version: --</span>
          </div>
        </div>
        <div class="flex gap-2 items-center">
          <div class="flex items-center gap-2">
            <label for="logoSelect" class="text-sm font-medium text-slate-700">Logo:</label>
            <select id="logoSelect" class="px-3 py-2 bg-white border border-slate-300 text-slate-700 text-sm rounded-lg hover:bg-slate-50 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="greenocare">GreenOCare</option>
              <option value="grove">Grove Systems</option>
            </select>
          </div>
          <button id="previewPdfBtn" class="inline-flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            Preview PDF
          </button>
          <button id="downloadPdfBtn" class="inline-flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3 3m0 0l-3-3m3 3V10"></path>
            </svg>
            Download PDF
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Status</p>
          <span id="quoteStatus" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
            Draft
          </span>
        </div>
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Total Amount</p>
          <p id="quoteTotal" class="text-lg font-semibold text-slate-900">₹0</p>
        </div>
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Valid Until</p>
          <p id="quoteValidUntil" class="text-sm text-slate-700">--</p>
        </div>
      </div>
    </div>

    <!-- Account Information Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">Account Information</h2>
      <div id="accountInfo" class="space-y-2">
        <div class="flex items-start gap-2">
          <svg class="w-5 h-5 text-slate-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          <div>
            <p class="text-sm font-medium text-slate-700" id="accountName">Loading...</p>
            <p class="text-xs text-slate-500" id="accountDetails"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">Products</h2>
      <div id="productsContainer">
        <div class="text-sm text-slate-500">Loading products...</div>
      </div>
    </div>

    <!-- Notes Card (if exists) -->
    <div id="notesCard" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">Notes</h2>
      <p id="quoteNotes" class="text-sm text-slate-700 whitespace-pre-wrap"></p>
    </div>
  </div>

  <script>
    import { getToken, logout, safeJsonParse } from '../lib/api';

    const API_BASE_URL = 'http://localhost:8080';

    const token = getToken();
    if (!token) {
      window.location.href = '/login';
    }

    // Get quote ID from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quoteId = urlParams.get('id');

    if (!quoteId) {
      window.location.href = '/quotes';
    }

    const loadingDiv = document.getElementById('loading') as HTMLDivElement;
    const errorDiv = document.getElementById('error') as HTMLDivElement;
    const errorText = document.getElementById('errorText') as HTMLParagraphElement;
    const quoteContent = document.getElementById('quoteContent') as HTMLDivElement;

    // Store quote data for PDF generation
    let currentQuoteData: any = null;

    /**
     * Fetch quote details - same method as PDF download
     * Fetches quote, account, and products in parallel
     */
    async function loadQuoteDetails() {
      try {
        // Fetch quote record to get basic details
        const quoteResponse = await fetch(`${API_BASE_URL}/proxy/quotes/records/${quoteId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        if (quoteResponse.status === 401) {
          logout();
          return;
        }

        if (!quoteResponse.ok) {
          throw new Error('Failed to fetch quote details');
        }

        const quoteData = await safeJsonParse(quoteResponse);
        const fields = quoteData.fields || {};

        // Fetch linked account using same route as PDF generation
        const accountResponse = await fetch(
          `${API_BASE_URL}/proxy/quotes/links/accounts_copy/${quoteId}?fields=Account Name,Phone,Billing Street,Billing City`,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );

        let accountName = 'N/A';
        let accountData = null;
        if (accountResponse.ok) {
          const accountResult = await safeJsonParse(accountResponse);
          const accounts = accountResult.list || accountResult.records || [];
          if (accounts.length > 0) {
            accountData = accounts[0].fields;
            accountName = accountData['Account Name'] || 'N/A';
          }
        }

        // Fetch linked products using same route as PDF generation
        const productsResponse = await fetch(
          `${API_BASE_URL}/proxy/quotes/links/products/${quoteId}?fields=Product Name,Unit Price,Brand,HSN Code,Model,Tax,Description`,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          }
        );

        let products: Array<{ name: string; price?: number }> = [];
        let productRecords: any[] = [];
        if (productsResponse.ok) {
          const productsData = await safeJsonParse(productsResponse);
          productRecords = productsData.list || productsData.records || [];
          products = productRecords.map((record: any) => ({
            name: record.fields['Product Name'] || 'Unnamed Product',
            price: record.fields['Unit Price'] 
              ? parseFloat(String(record.fields['Unit Price'])) 
              : undefined,
            model: record.fields['Model'] || undefined,
            tax: record.fields['Tax'] || undefined,
            description: record.fields['Description'] || undefined
          }));
        }

        // Store for PDF generation (same structure as download function)
        currentQuoteData = {
          id: parseInt(quoteId || '0'),
          subject: fields['Subject'] || `Quote #${quoteId || 'Unknown'}`,
          date: fields['Quote Date'] || new Date().toISOString().split('T')[0],
          version: fields['Quote Version'] || '1.0',
          total: fields['Total Amount'] || 0,
          account: {
            name: accountName
          },
          products: products
        };

        // Display quote details in UI
        displayQuoteDetails(fields, accountData, productRecords);

        loadingDiv.classList.add('hidden');
        quoteContent.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading quote details:', error);
        loadingDiv.classList.add('hidden');
        errorText.textContent = error instanceof Error ? error.message : 'Failed to load quote details';
        errorDiv.classList.remove('hidden');
      }
    }

    function displayQuoteDetails(fields: any, accountData: any, products: any[]) {
      // Header
      (document.getElementById('quoteSubject') as HTMLHeadingElement).textContent = fields['Subject'] || 'Untitled Quote';
      (document.getElementById('quoteDate') as HTMLSpanElement).textContent = `Date: ${fields['Quote Date'] || 'N/A'}`;
      (document.getElementById('quoteVersion') as HTMLSpanElement).textContent = `Version: ${fields['Quote Version'] || '1.0'}`;

      // Status
      const status = fields['Quote Status'] || 'Draft';
      const statusEl = document.getElementById('quoteStatus') as HTMLSpanElement;
      statusEl.textContent = status;
      
      let statusClasses = 'bg-slate-100 text-slate-800';
      if (status === 'Sent') statusClasses = 'bg-blue-100 text-blue-800';
      if (status === 'Accepted') statusClasses = 'bg-emerald-100 text-emerald-800';
      if (status === 'Rejected') statusClasses = 'bg-red-100 text-red-800';
      statusEl.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClasses}`;

      // Total
      const total = fields['Total Amount'] || 0;
      (document.getElementById('quoteTotal') as HTMLParagraphElement).textContent = 
        `₹${Number(total).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

      // Valid Until
      (document.getElementById('quoteValidUntil') as HTMLParagraphElement).textContent = fields['Valid Until'] || 'N/A';

      // Account
      const accountName = accountData?.['Account Name'] || 'No account linked';
      (document.getElementById('accountName') as HTMLParagraphElement).textContent = accountName;
      
      const accountDetails: string[] = [];
      if (accountData?.['Phone']) accountDetails.push(accountData['Phone']);
      if (accountData?.['Billing City']) accountDetails.push(accountData['Billing City']);
      
      const accountDetailsEl = document.getElementById('accountDetails') as HTMLParagraphElement;
      if (accountDetails.length > 0) {
        accountDetailsEl.textContent = accountDetails.join(' • ');
      } else {
        accountDetailsEl.textContent = '';
      }

      // Products
      const productsContainer = document.getElementById('productsContainer') as HTMLDivElement;
      if (products.length === 0) {
        productsContainer.innerHTML = '<p class="text-sm text-slate-500">No products linked to this quote</p>';
      } else {
        productsContainer.innerHTML = `
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-50 border-b border-slate-200">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Product</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Brand</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Model</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">HSN Code</th>
                  <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Unit Price</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tax</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                ${products.map((product: any) => {
                  const name = product.fields['Product Name'] || 'Unnamed Product';
                  const brand = product.fields['Brand'] || '-';
                  const model = product.fields['Model'] || '-';
                  const code = product.fields['HSN Code'] || '-';
                  const price = product.fields['Unit Price'] || 0;
                  const tax = product.fields['Tax'] || '-';
                  return `
                    <tr>
                      <td class="px-4 py-3 text-sm text-slate-900">${name}</td>
                      <td class="px-4 py-3 text-sm text-slate-600">${brand}</td>
                      <td class="px-4 py-3 text-sm text-slate-600">${model}</td>
                      <td class="px-4 py-3 text-sm text-slate-600">${code}</td>
                      <td class="px-4 py-3 text-sm text-slate-900 text-right">₹${Number(price).toLocaleString('en-IN')}</td>
                      <td class="px-4 py-3 text-sm text-slate-600">${tax}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      // Notes
      if (fields['Notes']) {
        const notesCard = document.getElementById('notesCard') as HTMLDivElement;
        const notesText = document.getElementById('quoteNotes') as HTMLParagraphElement;
        notesText.textContent = fields['Notes'];
        notesCard.classList.remove('hidden');
      }
    }

    /**
     * Generate PDF - reuses the same data already fetched
     */
    async function generatePDF(preview: boolean = false) {
      if (!currentQuoteData) {
        alert('Quote data not loaded');
        return;
      }

      try {
        const logoSelect = document.getElementById('logoSelect') as HTMLSelectElement;
        const selectedLogo = logoSelect?.value || 'greenocare';

        const response = await fetch('/api/quotes/pdf', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ...currentQuoteData,
            logo: selectedLogo
          })
        });

        if (!response.ok) {
          throw new Error('Failed to generate PDF');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        if (preview) {
          // Open in new tab for preview
          window.open(url, '_blank');
        } else {
          // Download
          const a = document.createElement('a');
          a.href = url;
          a.download = `quote-${quoteId}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Failed to generate PDF:', error);
        alert('Failed to generate PDF. Please try again.');
      }
    }

    // Event listeners
    document.getElementById('previewPdfBtn')?.addEventListener('click', () => generatePDF(true));
    document.getElementById('downloadPdfBtn')?.addEventListener('click', () => generatePDF(false));

    // Load quote details on page load
    loadQuoteDetails();
  </script>
</DashboardLayout>
