---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="User Management" currentPage="users">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-slate-800 mb-2">User Management</h1>
      <p class="text-slate-600">Create and manage user accounts</p>
    </div>

    <!-- Create User Form -->
    <div class="bg-white rounded-xl border border-slate-200 p-6 mb-8">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-semibold text-slate-800">Create New User</h2>
          <p class="text-sm text-slate-600">Add a new user account with temporary password</p>
        </div>
      </div>

      <!-- Alert -->
      <div id="alert" class="hidden mb-6"></div>

      <!-- Form -->
      <form id="createUserForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="email" class="block text-sm font-medium text-slate-700 mb-1">
              Email Address <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="user@example.com"
            />
          </div>

          <div>
            <label for="name" class="block text-sm font-medium text-slate-700 mb-1">
              Full Name
            </label>
            <input
              type="text"
              id="name"
              name="name"
              class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="John Doe"
            />
          </div>
        </div>

        <div>
          <label for="role" class="block text-sm font-medium text-slate-700 mb-1">
            Role <span class="text-red-500">*</span>
          </label>
          <select
            id="role"
            name="role"
            required
            class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all bg-white"
          >
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">Users have standard access, Admins can manage users</p>
        </div>

        <div class="flex items-center gap-3 pt-2">
          <button
            type="submit"
            id="submitBtn"
            class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Create User
          </button>
          <button
            type="button"
            id="resetBtn"
            class="px-6 py-2.5 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-all"
          >
            Reset
          </button>
        </div>
      </form>
    </div>

    <!-- Success Card (Hidden by default) -->
    <div id="successCard" class="hidden bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 p-6 mb-8">
      <div class="flex items-start gap-4 mb-4">
        <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-slate-800 mb-1">User Created Successfully!</h3>
          <p class="text-sm text-slate-600 mb-4">The user account has been created. Share the temporary password securely.</p>
          
          <div class="bg-white rounded-lg border border-green-200 p-4 space-y-3">
            <div>
              <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Email</p>
              <p class="text-sm font-medium text-slate-800" id="createdEmail">-</p>
            </div>
            <div>
              <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Temporary Password</p>
              <div class="flex items-center gap-2">
                <code class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm font-mono text-slate-800" id="tempPassword">-</code>
                <button
                  id="copyBtn"
                  class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                  title="Copy to clipboard"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <p class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">Role</p>
              <span id="createdRole" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">User</span>
            </div>
          </div>

          <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex gap-3">
              <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <div>
                <p class="text-sm font-medium text-yellow-800 mb-1">Important Security Notice</p>
                <ul class="text-xs text-yellow-700 space-y-1">
                  <li>• This password is shown only once and cannot be retrieved later</li>
                  <li>• Share it securely with the user (encrypted email, secure messaging, etc.)</li>
                  <li>• User will be required to change this password on first login</li>
                  <li>• Do not store this password in plain text</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button
        id="closeSuccessBtn"
        class="w-full mt-4 px-4 py-2 bg-white border border-green-300 text-green-700 font-medium rounded-lg hover:bg-green-50 transition-all"
      >
        Create Another User
      </button>
    </div>

    <!-- Info Card -->
    <div class="bg-blue-50 rounded-xl border border-blue-200 p-6">
      <div class="flex items-start gap-4">
        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div>
          <h3 class="font-semibold text-slate-800 mb-2">How User Creation Works</h3>
          <ul class="text-sm text-slate-600 space-y-1">
            <li>• A secure random password (16+ characters) is automatically generated</li>
            <li>• The user receives the temporary password from you (admin)</li>
            <li>• On first login, they must change their password</li>
            <li>• Until they change it, they cannot access the system</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { createUser, type CreateUserRequest } from '../../lib/api';

    const form = document.getElementById('createUserForm') as HTMLFormElement;
    const alertDiv = document.getElementById('alert') as HTMLDivElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const resetBtn = document.getElementById('resetBtn') as HTMLButtonElement;
    const successCard = document.getElementById('successCard') as HTMLDivElement;
    const closeSuccessBtn = document.getElementById('closeSuccessBtn') as HTMLButtonElement;
    const copyBtn = document.getElementById('copyBtn') as HTMLButtonElement;

    const emailInput = document.getElementById('email') as HTMLInputElement;
    const nameInput = document.getElementById('name') as HTMLInputElement;
    const roleSelect = document.getElementById('role') as HTMLSelectElement;

    function showAlert(message: string, type: 'success' | 'error') {
      alertDiv.textContent = message;
      alertDiv.className = `mb-6 p-4 rounded-lg ${
        type === 'success' 
          ? 'bg-green-50 text-green-800 border border-green-200' 
          : 'bg-red-50 text-red-800 border border-red-200'
      }`;
      alertDiv.classList.remove('hidden');
    }

    function hideAlert() {
      alertDiv.classList.add('hidden');
    }

    function showSuccess(email: string, password: string, role: string) {
      successCard.classList.remove('hidden');
      document.getElementById('createdEmail')!.textContent = email;
      document.getElementById('tempPassword')!.textContent = password;
      
      const roleSpan = document.getElementById('createdRole')!;
      roleSpan.textContent = role.charAt(0).toUpperCase() + role.slice(1);
      roleSpan.className = role === 'admin' 
        ? 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800'
        : 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800';

      // Scroll to success card
      successCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function hideSuccess() {
      successCard.classList.add('hidden');
    }

    function resetForm() {
      form.reset();
      hideAlert();
    }

    // Copy password to clipboard
    copyBtn?.addEventListener('click', async () => {
      const password = document.getElementById('tempPassword')!.textContent || '';
      try {
        await navigator.clipboard.writeText(password);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        `;
        copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        
        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
          copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
          copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
      } catch (error) {
        console.error('Failed to copy:', error);
      }
    });

    // Close success card
    closeSuccessBtn?.addEventListener('click', () => {
      hideSuccess();
      resetForm();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Reset button
    resetBtn?.addEventListener('click', resetForm);

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();
      hideSuccess();

      const email = emailInput.value.trim();
      const name = nameInput.value.trim();
      const role = roleSelect.value as 'user' | 'admin';

      // Validation
      if (!email) {
        showAlert('Email is required', 'error');
        return;
      }

      // Disable form
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating User...';

      try {
        const result = await createUser({ email, name, role });
        
        // Show success card with temporary password
        showSuccess(result.email, result.temporary_password, result.role);
        
        // Reset form
        form.reset();
      } catch (error) {
        showAlert(error instanceof Error ? error.message : 'Failed to create user', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create User';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create User';
      }
    });
  </script>
</AdminLayout>
